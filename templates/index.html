<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu√©t QR & ƒêƒÉng K√Ω</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <h2>Qu·∫£n l√Ω V√©</h2>
    
    <!-- Menu ch·ªçn ch·ª©c nƒÉng -->
    <select id="menu" onchange="switchMode()">
        <option value="add">Th√™m v√© m·ªõi</option>
        <option value="checkin">Check-in v√©</option>
    </select>

    <!-- Khu v·ª±c qu√©t QR -->
    <h3>Qu√©t QR</h3>
    <div id="qr-reader"></div>

    <!-- Form Th√™m v√© m·ªõi -->
    <form id="add-form" style="display:block;" enctype="multipart/form-data">
        <h3>Th√™m v√© m·ªõi</h3>
        <label>CODE: <input type="text" id="code" readonly></label><br>
        <label>T√™n: <input type="text" id="ten" required></label><br>
        <label>MSSV: <input type="text" id="mssv" required></label><br>
        <label>Email: <input type="email" id="mail" required></label><br>
        <label>SƒêT: <input type="text" id="sdt" required></label><br>

        <label>Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
        <select id="phuong_thuc_thanh_toan" required>
            <option value="">-- Ch·ªçn --</option>
            <option value="ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
            <option value="chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
        </select>
        <br>

        <label>Tr·∫°ng th√°i:</label>
        <select id="trang_thai" required>
            <option value="ch∆∞a mua">Ch∆∞a mua</option>
            <option value="ƒë√£ mua v√©">ƒê√£ mua v√©</option>
            <option value="ƒë√£ check in">ƒê√£ check in</option>
        </select>
        <br>

        <button type="button" onclick="saveData()">L∆∞u</button>
    </form>

    <!-- Form Check-in v√© -->
    <form id="checkin-form" style="display:none;">
        <h3>Check-in v√©</h3>
        <label>CODE: <input type="text" id="checkin-code" readonly></label><br>
        <label>T√™n: <input type="text" id="checkin-ten" readonly></label><br>
        <label>MSSV: <input type="text" id="checkin-mssv" readonly></label><br>
        <label>Email: <input type="text" id="checkin-mail" readonly></label><br>
        <label>SƒêT: <input type="text" id="checkin-sdt" readonly></label><br>
        <label>Tr·∫°ng th√°i: <input type="text" id="checkin-trang-thai" readonly></label><br>

        <button type="button" onclick="checkIn()">Check-in</button>
    </form>

    <script>
        let html5QrCode;

        function switchMode() {
            let mode = document.getElementById("menu").value;
            document.getElementById("add-form").style.display = (mode === "add") ? "block" : "none";
            document.getElementById("checkin-form").style.display = (mode === "checkin") ? "block" : "none";
            
            restartCamera();  // üöÄ Lu√¥n kh·ªüi ƒë·ªông l·∫°i camera khi chuy·ªÉn ch·∫ø ƒë·ªô
        }

        function restartCamera() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log("üîÑ Camera kh·ªüi ƒë·ªông l·∫°i...");
                    startCamera();
                }).catch(err => console.error("‚ùå L·ªói d·ª´ng camera:", err));
            } else {
                startCamera();
            }
        }

        function startCamera() {
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).catch(err => console.error("‚ùå L·ªói m·ªü camera:", err));
        }

        function onScanSuccess(qrCodeMessage) {
            console.log("üì© QR Code qu√©t ƒë∆∞·ª£c:", qrCodeMessage);

            fetch('/scan', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({code: qrCodeMessage})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "found") {
                    if (document.getElementById("menu").value === "add") {
                        document.getElementById("code").value = data.code;
                        document.getElementById("add-form").style.display = "block";
                    } else {
                        document.getElementById("checkin-code").value = data.code;
                        document.getElementById("checkin-ten").value = data.data.TEN || "";
                        document.getElementById("checkin-mssv").value = data.data.MSSV || "";
                        document.getElementById("checkin-mail").value = data.data.MAIL || "";
                        document.getElementById("checkin-sdt").value = data.data.SDT || "";
                        document.getElementById("checkin-trang-thai").value = data.data.TRANG_THAI || "ch∆∞a mua";
                        document.getElementById("checkin-form").style.display = "block";
                    }
                } else {
                    alert("‚ùå QR Code kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng!");
                }
            })
            .catch(error => console.error("‚ùå L·ªói khi qu√©t QR:", error));
        }

        function saveData() {
            let formData = new FormData();
            formData.append("ten", document.getElementById("ten").value);
            formData.append("mssv", document.getElementById("mssv").value);
            formData.append("mail", document.getElementById("mail").value);
            formData.append("sdt", document.getElementById("sdt").value);
            formData.append("phuong_thuc_thanh_toan", document.getElementById("phuong_thuc_thanh_toan").value);
            formData.append("trang_thai", document.getElementById("trang_thai").value);

            fetch('/update', {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "C·∫≠p nh·∫≠t th√†nh c√¥ng!") {
                    alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    document.getElementById("add-form").reset();
                    document.getElementById("add-form").style.display = "none";
                } else {
                    alert("‚ùå L·ªói c·∫≠p nh·∫≠t: " + data.error);
                }
            })
            .catch(error => console.error("‚ùå Fetch error:", error));
        }

        function checkIn() {
            let code = document.getElementById("checkin-code").value;

            fetch('/checkin', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({code: code})
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Check-in th√†nh c√¥ng!") {
                    alert("‚úÖ ƒê√£ check-in th√†nh c√¥ng!");
                    document.getElementById("checkin-trang-thai").value = "ƒë√£ check in";
                } else {
                    alert("‚ùå L·ªói check-in: " + data.error);
                }
            })
            .catch(error => console.error("‚ùå Fetch error:", error));
        }
    </script>
</body>
</html>